<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ-панель - Система мониторинга веб-страниц</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #5046e5;
      --primary-light: #6e66ff;
      --secondary-color: #f0f0ff;
      --text-color: #333;
      --text-light: #666;
      --border-color: #e0e0e0;
      --danger-color: #e53935;
      --warning-color: #f57c00;
      --success-color: #43a047;
      --background-light: #f9f9ff;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.5;
      color: var(--text-color);
      background-color: #f5f5f5;
      padding: 0;
      overflow-x: hidden;
    }
    
    header {
      background-color: #fff;
      border-bottom: 1px solid var(--border-color);
      padding: 1rem;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .logo-icon {
      width: 24px;
      height: 24px;
      background-color: var(--primary-color);
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .nav-links {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .nav-link {
      font-size: 0.8rem;
      color: var(--text-light);
      padding: 0.25rem 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: transparent;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }
    
    .nav-link.active {
      background-color: var(--secondary-color);
      color: var(--primary-color);
    }
    
    .logout-btn {
      font-size: 0.8rem;
      color: var(--text-light);
      padding: 0.25rem 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: transparent;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }
    
    .logout-btn:hover {
      background-color: var(--secondary-color);
      color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    .dashboard {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1.5rem;
      margin-top: 1rem;
    }
    
    .clients-panel {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 1rem;
      height: calc(100vh - 130px);
      overflow-y: auto;
    }
    
    .panel-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .client-count {
      background-color: var(--primary-color);
      color: white;
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
      border-radius: 50px;
    }
    
    .client-list {
      list-style: none;
    }
    
    .client-item {
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background-color 0.2s;
      border: 1px solid var(--border-color);
    }
    
    .client-item:hover {
      background-color: var(--background-light);
    }
    
    .client-item.active {
      background-color: var(--secondary-color);
      border-color: var(--primary-color);
    }
    
    .client-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
    }
    
    .client-id {
      font-size: 0.8rem;
      color: var(--text-light);
      font-family: monospace;
    }
    
    .client-url {
      font-size: 0.9rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .client-title {
      font-size: 0.8rem;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .client-status {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--success-color);
    }
    
    .status-dot.paused {
      background-color: var(--warning-color);
    }
    
    .client-time {
      font-size: 0.75rem;
      color: var(--text-light);
    }
    
    .no-clients {
      color: var(--text-light);
      font-size: 0.9rem;
      text-align: center;
      margin-top: 3rem;
    }
    
    .content-panel {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 1rem;
      height: calc(100vh - 130px);
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
      padding: 0.75rem 1.25rem;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
    }
    
    .tab-content {
      display: none;
      height: 100%;
      overflow: auto;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .preview-tab {
      width: 100%;
      height: 100%;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
    }
    
    .preview-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .error-message {
      padding: 1rem;
      color: var(--text-light);
      text-align: center;
    }
    
    .html-tab, .text-tab {
      width: 100%;
      height: 100%;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: auto;
      background-color: #fff;
    }
    
    .html-content, .text-content {
      padding: 1rem;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 0.85rem;
      line-height: 1.5;
    }
    
    .actions-panel {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 1rem;
      margin-top: 1rem;
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-light);
    }
    
    .btn-secondary {
      background-color: var(--secondary-color);
      color: var(--primary-color);
    }
    
    .btn-secondary:hover {
      background-color: #e6e6ff;
    }
    
    .btn-danger {
      background-color: #ffebee;
      color: var(--danger-color);
    }
    
    .btn-danger:hover {
      background-color: #ffcdd2;
    }
    
    .btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-light);
      padding: 0.25rem;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-icon:hover {
      background-color: var(--background-light);
      color: var(--primary-color);
    }
    
    .message-form {
      display: grid;
      gap: 0.5rem;
    }
    
    .form-group {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .form-control {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.9rem;
      font-family: inherit;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    .opacity-slider {
      width: 100px;
    }
    
    .settings-form {
      margin-top: 1rem;
      border-top: 1px solid var(--border-color);
      padding-top: 1rem;
    }
    
    .form-title {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-light);
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 2rem;
      color: var(--text-light);
    }
    
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }
    
    .preview-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      padding: 5px;
      background-color: #f5f5f5;
      border-radius: 4px;
    }
    
    .preview-toggle {
      font-size: 0.8rem;
      padding: 2px 8px;
      background-color: var(--secondary-color);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      cursor: pointer;
    }
    
    .preview-toggle.active {
      background-color: var(--primary-color);
      color: white;
    }

    .preview-mode-select {
      font-size: 0.8rem;
      padding: 2px 8px;
      background-color: var(--secondary-color);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      cursor: pointer;
    }
    
    /* Стили для истории сообщений */
    .message-history-container {
      background-color: #fff;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      padding: 1rem;
      height: 100%;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .message-list {
      list-style: none;
      margin-bottom: 1rem;
      flex-grow: 1;
      overflow-y: auto;
    }
    
    .message-item {
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      border: 1px solid var(--border-color);
      background-color: #fff;
      transition: background-color 0.2s;
      position: relative;
    }
    
    .message-item:hover {
      background-color: var(--background-light);
    }
    
    .message-timestamp {
      font-size: 0.7rem;
      color: var(--text-light);
      margin-bottom: 0.25rem;
    }
    
    .message-text {
      font-size: 0.9rem;
      color: var(--text-color);
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .message-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-light);
    }
    
    .message-opacity {
      background-color: var(--secondary-color);
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
    }
    
    .message-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .message-action-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-light);
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .message-action-btn:hover {
      background-color: var(--secondary-color);
      color: var(--primary-color);
    }
    
    .message-action-btn.delete:hover {
      background-color: #ffebee;
      color: var(--danger-color);
    }
    
    .message-edit-form {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border-color);
      display: none;
    }
    
    .message-edit-form.active {
      display: block;
    }
    
    .message-edit-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
    }
    
    .message-edit-opacity {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .message-edit-opacity label {
      font-size: 0.8rem;
      color: var(--text-light);
    }
    
    .message-edit-opacity input {
      width: 100%;
    }
    
    .message-edit-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    
    .message-save-btn, .message-cancel-btn {
      padding: 0.35rem 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      border: none;
    }
    
    .message-save-btn {
      background-color: var(--primary-color);
      color: white;
    }
    
    .message-save-btn:hover {
      background-color: var(--primary-light);
    }
    
    .message-cancel-btn {
      background-color: #f5f5f5;
      color: var(--text-color);
    }
    
    .message-cancel-btn:hover {
      background-color: #e0e0e0;
    }
    
    @media (max-width: 1024px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      .clients-panel {
        height: auto;
        max-height: 300px;
      }
      
      .content-panel {
        height: auto;
      }
    }

    /* Стили для улучшенной вкладки HTML */
    .html-tab {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .html-controls {
      display: flex;
      padding: 8px;
      background-color: #f5f5f5;
      border-bottom: 1px solid #ddd;
      align-items: center;
      gap: 8px;
    }

    .search-container {
      display: flex;
      align-items: center;
      margin-left: auto;
      gap: 4px;
    }

    #html-search {
      width: 200px;
    }

    #search-result-count {
      font-size: 12px;
      color: #666;
      margin: 0 4px;
      min-width: 40px;
      text-align: center;
    }

    .html-viewer {
      display: flex;
      flex-grow: 1;
      overflow: auto;
      position: relative;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      background-color: #f8f8f8;
    }

    .line-numbers {
      display: flex;
      flex-direction: column;
      padding: 8px 8px 8px 0;
      background-color: #f1f1f1;
      border-right: 1px solid #ddd;
      text-align: right;
      user-select: none;
      color: #999;
      min-width: 40px;
    }

    .line-numbers span {
      padding: 0 8px;
    }

    .html-content {
      flex-grow: 1;
      margin: 0;
      padding: 8px;
      white-space: pre-wrap;
      word-break: break-word;
      tab-size: 2;
    }

    /* Подсветка синтаксиса */
    .html-tag {
      color: #0000ff;
    }

    .html-attr {
      color: #7f0055;
      font-weight: bold;
    }

    .html-string {
      color: #2a9d1a;
    }

    .html-comment {
      color: #888;
      font-style: italic;
    }

    /* Подсветка поиска */
    .search-match {
      background-color: rgba(255, 255, 0, 0.3);
      padding: 2px 0;
    }

    .search-match.current {
      background-color: orange;
      color: white;
    }

    /* Медиа-запрос для адаптивности */
    @media (max-width: 768px) {
      .html-controls {
        flex-wrap: wrap;
      }
      
      .search-container {
        margin-left: 0;
        margin-top: 8px;
        width: 100%;
      }
      
      #html-search {
        width: 100%;
      }
    }

    /* Стили для модального окна выполнения HTML */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: auto;
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 0;
      width: 90%;
      max-width: 1400px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      height: 85%;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--primary-color);
    }

    .close-modal {
      color: var(--text-light);
      font-size: 1.5rem;
      cursor: pointer;
      font-weight: bold;
    }

    .close-modal:hover {
      color: var(--primary-color);
    }

    .modal-body {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 0;
      overflow: hidden;
    }

    .modal-toolbar {
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 10px;
    }

    .html-run-container {
      flex-grow: 1;
      position: relative;
      overflow: hidden;
    }

    .editor-preview-container {
      display: flex;
      height: 100%;
    }

    .html-editor-container {
      width: 50%;
      height: 100%;
      border-right: 1px solid var(--border-color);
      overflow: hidden;
    }

    #html-editor {
      width: 100%;
      height: 100%;
      border: none;
      padding: 15px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      resize: none;
      background-color: #f8f8f8;
      color: var(--text-color);
    }

    .html-preview-wrapper {
      width: 50%;
      height: 100%;
      overflow: hidden;
    }

    #html-run-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background-color: white;
    }

    .fullscreen-modal .modal-content {
      width: 100%;
      height: 100%;
      margin: 0;
      border-radius: 0;
    }

    .editor-hidden .html-editor-container {
      display: none;
    }

    .editor-hidden .html-preview-wrapper {
      width: 100%;
    }

    .btn-success {
      background-color: #4caf50;
      color: white;
    }

    .btn-success:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">M</div>
        <span>Web Monitoring</span>
      </div>
      
      <div class="nav-links">
        <a href="/admin" class="nav-link active">Монитор</a>
        <a href="/admin/access-codes" class="nav-link">Коды доступа</a>
        <a href="/admin/users" class="nav-link">Пользователи</a>
        <a href="/admin/sessions" class="nav-link">Сессии</a>
        <a href="/admin/export-import" class="nav-link">Экспорт/Импорт</a>
        <button id="logout-btn" class="logout-btn">Выйти</button>
      </div>
      
      <div class="header-right">
        <div id="connection-status">Подключение...</div>
      </div>
    </div>
  </header>
  
  <main class="container">
    <div class="dashboard">
      <aside class="clients-panel">
        <div class="panel-title">
          Подключенные клиенты <span class="client-count" id="client-count">0</span>
        </div>
        <ul class="client-list" id="client-list">
          <div class="no-clients">Нет подключенных клиентов</div>
        </ul>
      </aside>
      
      <section class="content-panel">
        <div class="tabs" id="tabs">
          <div class="tab active" data-tab="preview">Превью страницы</div>
          <div class="tab" data-tab="html">HTML код</div>
          <div class="tab" data-tab="text">Текстовое содержимое</div>
          <div class="tab" data-tab="messages">История сообщений</div>
        </div>
        
        <div class="tab-content active" id="preview-tab">
          <div class="preview-controls" id="preview-controls" style="display: none;">
            <button id="toggle-links" class="preview-toggle">Включить интерактивность</button>
            <span class="preview-info">Интерактивность отключена для безопасности</span>
            <select id="preview-mode" class="preview-mode-select">
              <option value="static">Обычный режим</option>
              <option value="iframe">Iframe режим (полная интерактивность)</option>
            </select>
          </div>
          <div class="preview-tab">
            <div class="empty-state">
              <div class="empty-icon">👆</div>
              <p>Выберите клиента из списка слева для просмотра данных</p>
            </div>
          </div>
        </div>
        
        <div class="tab-content" id="html-tab">
          <div class="html-tab">
            <div class="html-controls">
              <button id="copy-html-btn" class="btn btn-sm btn-primary">Копировать HTML</button>
              <button id="format-html-btn" class="btn btn-sm btn-secondary">Форматировать</button>
              <button id="download-html-btn" class="btn btn-sm btn-info">Скачать HTML</button>
              <button id="run-html-btn" class="btn btn-sm btn-success">Запустить HTML</button>
              <div class="search-container">
                <input type="text" id="html-search" placeholder="Поиск в HTML" class="form-control form-control-sm">
                <span id="search-result-count">0/0</span>
                <button id="search-prev-btn" class="btn btn-sm btn-outline-secondary">⬆</button>
                <button id="search-next-btn" class="btn btn-sm btn-outline-secondary">⬇</button>
              </div>
            </div>
            <div class="html-viewer">
              <div class="line-numbers" id="line-numbers"></div>
              <pre id="html-content" class="html-content"></pre>
            </div>
          </div>
        </div>
        
        <div class="tab-content" id="text-tab">
          <div class="text-tab">
            <div class="text-content" id="text-content"></div>
          </div>
        </div>
        
        <div class="tab-content" id="messages-tab">
          <div class="message-history-container">
            <div class="message-list">
              <!-- Сообщения будут добавляться здесь -->
            </div>
            <div class="message-actions">
              <button id="clear-messages-btn" class="btn btn-danger" style="margin-right: 10px;">Очистить все сообщения</button>
              <button class="message-action-btn add-message">Добавить сообщение</button>
            </div>
          </div>
        </div>
      </section>
    </div>
    
    <div class="actions-panel" id="actions-panel" style="display: none;">
      <div class="panel-title">Управление клиентом</div>
      
      <div class="action-buttons">
        <button id="pause-btn" class="btn btn-secondary">
          <span id="pause-icon">⏸️</span> <span id="pause-text">Пауза</span>
        </button>
        <button id="remove-btn" class="btn btn-danger">
          🗑️ Удалить
        </button>
      </div>
      
      <div class="message-form">
        <div class="form-title">Отправить сообщение</div>
        <div class="form-group">
          <input type="text" id="message-input" class="form-control" placeholder="Введите сообщение">
          <input type="range" id="opacity-slider" class="opacity-slider form-control" min="0.1" max="1" step="0.1" value="0.7">
          <button id="send-message-btn" class="btn btn-primary">Отправить</button>
        </div>
      </div>
      
      <div class="settings-form">
        <div class="form-title">Настройки клиента</div>
        <div class="form-group">
          <label for="update-interval">Интервал обновления (мин):</label>
          <input type="number" id="update-interval" class="form-control" min="1" value="25">
        </div>
        
        <div class="form-group">
          <label for="font-size-slider">Размер шрифта просмотрщика:</label>
          <input type="range" id="font-size-slider" class="form-control" min="8" max="24" step="1" value="12">
          <span id="font-size-value">12px</span>
        </div>
        
        <div class="form-group">
          <label for="opacity-viewer-slider">Прозрачность просмотрщика:</label>
          <input type="range" id="opacity-viewer-slider" class="form-control" min="0.1" max="1" step="0.1" value="0.8">
          <span id="opacity-viewer-value">0.8</span>
        </div>
        
        <button id="update-settings-btn" class="btn btn-primary">Сохранить</button>
      </div>
    </div>
  </main>
  
  <div id="html-run-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Редактирование и запуск HTML</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="modal-body">
        <div class="modal-toolbar">
          <button id="modal-apply-changes" class="btn btn-sm btn-success">Применить изменения</button>
          <button id="modal-toggle-fullscreen" class="btn btn-sm btn-secondary">На весь экран</button>
          <button id="modal-open-new-window" class="btn btn-sm btn-primary">Открыть в новом окне</button>
          <button id="modal-toggle-editor" class="btn btn-sm btn-info">Показать/скрыть редактор</button>
        </div>
        <div class="html-run-container">
          <div class="editor-preview-container">
            <div class="html-editor-container">
              <textarea id="html-editor" spellcheck="false"></textarea>
            </div>
            <div class="html-preview-wrapper">
              <iframe id="html-run-iframe" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Глобальные переменные для WebSocket соединения и состояния приложения
    let ws = null;
    let selectedClientId = null;
    
    document.addEventListener('DOMContentLoaded', function() {
      // Элементы интерфейса
      const connectionStatus = document.getElementById('connection-status');
      const clientList = document.getElementById('client-list');
      const clientCount = document.getElementById('client-count');
      const tabs = document.getElementById('tabs');
      const tabContents = document.querySelectorAll('.tab-content');
      const pauseBtn = document.getElementById('pause-btn');
      const pauseIcon = document.getElementById('pause-icon');
      const pauseText = document.getElementById('pause-text');
      const removeBtn = document.getElementById('remove-btn');
      const sendMessageBtn = document.getElementById('send-message-btn');
      const messageInput = document.getElementById('message-input');
      const opacitySlider = document.getElementById('opacity-slider');
      const updateIntervalInput = document.getElementById('update-interval');
      const updateSettingsBtn = document.getElementById('update-settings-btn');
      const fontSizeSlider = document.getElementById('font-size-slider');
      const fontSizeValue = document.getElementById('font-size-value');
      const opacityViewerSlider = document.getElementById('opacity-viewer-slider');
      const opacityViewerValue = document.getElementById('opacity-viewer-value');
      const actionsPanel = document.getElementById('actions-panel');
      const previewTab = document.getElementById('preview-tab');
      const htmlContent = document.getElementById('html-content');
      const textContent = document.getElementById('text-content');
      const previewControls = document.getElementById('preview-controls');
      const toggleLinksBtn = document.getElementById('toggle-links');
      const previewModeSelect = document.getElementById('preview-mode');
      
      // Состояние приложения
      let clients = [];
      let reconnectAttempts = 0;
      let interactivityEnabled = false;
      let currentPreviewMode = 'static';
      let currentClientData = null;
      
      // Массив для хранения истории сообщений текущего клиента
      let currentClientMessages = [];
      
      // Функции для работы с WebSocket
      function connectToServer() {
        // Определяем хост сервера динамически
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = location.host;
        const wsUrl = `${protocol}//${host}`;
        
        connectionStatus.textContent = 'Подключение...';
        connectionStatus.style.color = '#f57c00';
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
          connectionStatus.textContent = 'Подключено';
          connectionStatus.style.color = '#43a047';
          reconnectAttempts = 0;
          
          // Регистрируемся как админ
          ws.send(JSON.stringify({
            type: 'register',
            role: 'admin'
          }));
        };
        
        ws.onmessage = function(event) {
          try {
            const message = JSON.parse(event.data);
            
            switch (message.type) {
              case 'clientList':
                clients = message.clients;
                updateClientList();
                break;
                
              case 'clientConnected':
                // Добавляем нового клиента в список
                clients.push({
                  clientId: message.clientId,
                  paused: false,
                  pageData: null,
                  timestamp: message.timestamp
                });
                updateClientList();
                break;
                
              case 'clientReconnected':
                // Обновляем статус переподключенного клиента
                const reconnectedClientIndex = clients.findIndex(client => client.clientId === message.clientId);
                if (reconnectedClientIndex !== -1) {
                  // Клиент уже есть в списке, обновляем его статус
                  clients[reconnectedClientIndex].timestamp = message.timestamp;
                } else {
                  // На случай, если клиента нет в списке, добавляем его
                  clients.push({
                    clientId: message.clientId,
                    paused: false,
                    pageData: null,
                    timestamp: message.timestamp
                  });
                }
                updateClientList();
                break;
                
              case 'clientDisconnected':
                // Удаляем клиента из списка
                clients = clients.filter(client => client.clientId !== message.clientId);
                
                // Если был выбран этот клиент, сбрасываем выбор
                if (selectedClientId === message.clientId) {
                  selectedClientId = null;
                  actionsPanel.style.display = 'none';
                  clearClientData();
                }
                
                updateClientList();
                break;
                
              case 'clientUpdate':
                // Обновляем данные клиента
                const clientIndex = clients.findIndex(client => client.clientId === message.clientId);
                if (clientIndex !== -1) {
                  clients[clientIndex].pageData = message.pageData;
                  clients[clientIndex].timestamp = message.pageData.timestamp;
                  updateClientList();
                  
                  // Если этот клиент выбран, обновляем отображаемые данные
                  if (selectedClientId === message.clientId) {
                    displayClientData(clients[clientIndex]);
                  }
                }
                break;
                
              case 'clientPaused':
                // Отмечаем клиента как приостановленного
                const pausedClientIndex = clients.findIndex(client => client.clientId === message.clientId);
                if (pausedClientIndex !== -1) {
                  clients[pausedClientIndex].paused = true;
                  updateClientList();
                  
                  // Если этот клиент выбран, обновляем кнопку паузы
                  if (selectedClientId === message.clientId) {
                    updatePauseButton(true);
                  }
                }
                break;
                
              case 'clientResumed':
                // Отмечаем клиента как активного
                const resumedClientIndex = clients.findIndex(client => client.clientId === message.clientId);
                if (resumedClientIndex !== -1) {
                  clients[resumedClientIndex].paused = false;
                  updateClientList();
                  
                  // Если этот клиент выбран, обновляем кнопку паузы
                  if (selectedClientId === message.clientId) {
                    updatePauseButton(false);
                  }
                }
                break;
                
              case 'clientRemoved':
                // Удаляем клиента из списка
                clients = clients.filter(client => client.clientId !== message.clientId);
                
                // Если был выбран этот клиент, сбрасываем выбор
                if (selectedClientId === message.clientId) {
                  selectedClientId = null;
                  actionsPanel.style.display = 'none';
                  clearClientData();
                }
                
                updateClientList();
                break;
                
              case 'adminMessageHistory':
                // Сохраняем полученную историю сообщений
                currentClientMessages = message.messages;
                
                // Отображаем историю сообщений
                displayMessageHistory(currentClientMessages);
                break;
                
              case 'messageEditSuccess':
                // Обновляем историю сообщений после успешного редактирования
                console.log('Сообщение успешно отредактировано, обновляем список для клиента:', message.clientId);
                loadMessageHistory(message.clientId);
                break;
                
              case 'messageEditError':
                alert(`Ошибка редактирования сообщения: ${message.error}`);
                break;
                
              case 'messageDeleteSuccess':
                // Обновляем историю сообщений после успешного удаления
                console.log('Сообщение успешно удалено, обновляем список для клиента:', message.clientId);
                loadMessageHistory(message.clientId);
                break;
                
              case 'messageDeleteError':
                alert(`Ошибка удаления сообщения: ${message.error}`);
                break;
                
              case 'messagesCleared':
                // Если сообщения были очищены
                if (message.clientId === selectedClientId && 
                    document.querySelector('.tab[data-tab="messages"]').classList.contains('active')) {
                  console.log('Получено подтверждение очистки сообщений для клиента:', message.clientId);
                  // Очищаем контейнер с сообщениями
                  const messagesContainer = document.querySelector('.message-list');
                  if (messagesContainer) {
                    messagesContainer.innerHTML = '<div class="empty-state">Нет сообщений</div>';
                  }
                  // Обнуляем массив с сообщениями
                  currentClientMessages = [];
                }
                break;
                
              case 'messageEdited':
                // Если сообщение было отредактировано другим админом
                if (message.clientId === selectedClientId && 
                    document.querySelector('.tab[data-tab="messages"]').classList.contains('active')) {
                  loadMessageHistory(message.clientId);
                }
                break;
                
              case 'messageDeleted':
                // Если сообщение было удалено другим админом
                if (message.clientId === selectedClientId && 
                    document.querySelector('.tab[data-tab="messages"]').classList.contains('active')) {
                  loadMessageHistory(message.clientId);
                }
                break;
            }
          } catch (error) {
            console.error('Ошибка обработки сообщения:', error);
          }
        };
        
        ws.onclose = function() {
          connectionStatus.textContent = 'Отключено';
          connectionStatus.style.color = '#e53935';
          
          // Пытаемся переподключиться с увеличивающейся задержкой
          const delay = Math.min(30000, 1000 * Math.pow(2, reconnectAttempts));
          reconnectAttempts++;
          
          console.log(`Попытка переподключения через ${delay}мс...`);
          setTimeout(connectToServer, delay);
        };
        
        ws.onerror = function(error) {
          console.error('Ошибка WebSocket:', error);
          connectionStatus.textContent = 'Ошибка подключения';
          connectionStatus.style.color = '#e53935';
        };
      }
      
      // Обновление списка клиентов
      function updateClientList() {
        clientCount.textContent = clients.length;
        
        if (clients.length === 0) {
          clientList.innerHTML = '<div class="no-clients">Нет подключенных клиентов</div>';
          return;
        }
        
        // Сортируем клиентов: сначала активные, затем по времени последнего обновления
        clients.sort((a, b) => {
          if (a.paused !== b.paused) {
            return a.paused ? 1 : -1;
          }
          return new Date(b.timestamp || 0) - new Date(a.timestamp || 0);
        });
        
        clientList.innerHTML = '';
        
        clients.forEach(client => {
          const li = document.createElement('li');
          li.className = 'client-item' + (selectedClientId === client.clientId ? ' active' : '');
          li.dataset.clientId = client.clientId;
          
          const title = client.pageData ? client.pageData.title : 'Новый клиент';
          const url = client.pageData ? client.pageData.url : 'Ожидание данных...';
          const timestamp = client.timestamp ? formatTime(new Date(client.timestamp)) : 'Н/Д';
          
          li.innerHTML = `
            <div class="client-item-header">
              <div class="client-status">
                <span class="status-dot${client.paused ? ' paused' : ''}"></span>
                <span>${client.paused ? 'Пауза' : 'Активен'}</span>
              </div>
              <span class="client-time">${timestamp}</span>
            </div>
            <div class="client-url">${url}</div>
            <div class="client-title">${title}</div>
            <div class="client-id">${client.clientId.substr(0, 8)}...</div>
          `;
          
          li.addEventListener('click', () => selectClient(client.clientId));
          clientList.appendChild(li);
        });
      }
      
      // Выбор клиента
      function selectClient(clientId) {
        console.log('Выбран клиент:', clientId);
        selectedClientId = clientId;
        
        // Обновляем активный класс в списке
        document.querySelectorAll('.client-item').forEach(item => {
          item.classList.toggle('active', item.dataset.clientId === clientId);
        });
        
        // Находим клиента и отображаем его данные
        const client = clients.find(c => c.clientId === clientId);
        if (client) {
          displayClientData(client);
          actionsPanel.style.display = 'block';
          updatePauseButton(client.paused);
        }
        
        // Загружаем историю сообщений, если активна вкладка messages
        const messagesTab = document.querySelector('.tab[data-tab="messages"]');
        if (messagesTab && messagesTab.classList.contains('active')) {
          console.log('Вкладка сообщений активна, запрашиваем историю');
          loadMessageHistory(clientId);
        }
        
        // Запрашиваем информацию о клиенте
        ws.send(JSON.stringify({
          type: 'getClientInfo',
          clientId: clientId
        }));
      }
      
      // Отображение данных клиента
      function displayClientData(client) {
        const pageData = client.pageData;
        currentClientData = client;
        
        if (!pageData) {
          clearClientData();
          previewTab.innerHTML = `
            <div class="preview-controls" id="preview-controls" style="display: none;">
              <button id="toggle-links" class="preview-toggle">Включить интерактивность</button>
              <span class="preview-info">Интерактивность отключена для безопасности</span>
              <select id="preview-mode" class="preview-mode-select">
                <option value="static">Обычный режим</option>
                <option value="iframe">Iframe режим (полная интерактивность)</option>
              </select>
            </div>
            <div class="preview-tab">
              <div class="empty-state">
                <div class="empty-icon">⏳</div>
                <p>Ожидание данных от клиента...</p>
              </div>
            </div>
          `;
          return;
        }
        
        // Показываем панель управления превью
        previewControls.style.display = 'flex';
        
        // Режим отображения зависит от выбранного варианта
        if (currentPreviewMode === 'iframe') {
          displayIframePreview(pageData);
        } else {
          displayStaticPreview(pageData);
        }
        
        // Отображаем улучшенное извлечение текста из HTML
        extractAndDisplayAllText(pageData.html);
        
        // Отображаем HTML код
        displayFormattedHtml(pageData.html);
      }
      
      // Отображение статического превью HTML
      function displayStaticPreview(pageData) {
        previewTab.innerHTML = `
          <div class="preview-controls" id="preview-controls">
            <button id="toggle-links" class="preview-toggle ${interactivityEnabled ? 'active' : ''}">
              ${interactivityEnabled ? 'Отключить интерактивность' : 'Включить интерактивность'}
            </button>
            <span class="preview-info">${interactivityEnabled ? 'Интерактивность включена' : 'Интерактивность отключена для безопасности'}</span>
            <select id="preview-mode" class="preview-mode-select">
              <option value="static" selected>Обычный режим</option>
              <option value="iframe">Iframe режим (полная интерактивность)</option>
            </select>
          </div>
          <div class="preview-tab">
            <div class="html-preview-container">${pageData.html}</div>
          </div>
        `;
        
        // Восстанавливаем обработчики событий
        document.getElementById('toggle-links').addEventListener('click', toggleInteractivity);
        document.getElementById('preview-mode').addEventListener('change', changePreviewMode);
        
        // Добавляем стили для HTML превью с учетом состояния интерактивности
        const styleElement = document.createElement('style');
        styleElement.textContent = `
          .html-preview-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            padding: 10px;
            background-color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          }
          
          .html-preview-container img {
            max-width: 100%;
          }
          
          .html-preview-container a {
            ${interactivityEnabled ? '' : 'pointer-events: none; cursor: not-allowed;'}
            color: #0066cc;
          }
          
          .html-preview-container * {
            max-width: 100%;
            ${interactivityEnabled ? '' : 'pointer-events: none;'}
          }
          
          .html-preview-container table {
            border-collapse: collapse;
            width: auto;
          }
          
          .html-preview-container table td, 
          .html-preview-container table th {
            border: 1px solid #ddd;
            padding: 8px;
          }
        `;
        document.head.appendChild(styleElement);
        
        // Если интерактивность включена, добавляем обработчики событий
        if (interactivityEnabled) {
          enableInteractivity();
        }
      }
      
      // Отображение iframe превью с полной интерактивностью
      function displayIframePreview(pageData) {
        previewTab.innerHTML = `
          <div class="preview-controls" id="preview-controls">
            <button id="toggle-links" class="preview-toggle active" disabled>
              Интерактивность включена
            </button>
            <span class="preview-info">Режим iframe - полная интерактивность</span>
            <select id="preview-mode" class="preview-mode-select">
              <option value="static">Обычный режим</option>
              <option value="iframe" selected>Iframe режим (полная интерактивность)</option>
            </select>
          </div>
          <div class="preview-tab">
            <iframe id="preview-iframe" sandbox="allow-same-origin allow-scripts allow-forms" style="width: 100%; height: 100%; border: none;"></iframe>
          </div>
        `;
        
        // Восстанавливаем обработчик события для выбора режима
        document.getElementById('preview-mode').addEventListener('change', changePreviewMode);
        
        // Создаем iframe с содержимым страницы
        const iframe = document.getElementById('preview-iframe');
        
        // Ждем загрузки iframe
        iframe.onload = function() {
          try {
            // Применяем дополнительные стили для масштабирования контента
            const styleElement = document.createElement('style');
            styleElement.textContent = `
              body { 
                margin: 0;
                padding: 10px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              }
              img { max-width: 100%; }
              * { max-width: 100%; }
              table { border-collapse: collapse; width: auto; }
              table td, table th { border: 1px solid #ddd; padding: 8px; }
            `;
            iframe.contentWindow.document.head.appendChild(styleElement);
          } catch (error) {
            console.error('Ошибка при применении стилей к iframe:', error);
          }
        };
        
        // Загружаем HTML в iframe
        iframe.srcdoc = pageData.html;
      }
      
      // Функция для извлечения и отображения всего текста, включая скрытый
      function extractAndDisplayAllText(html) {
        try {
          // Создаем временный контейнер для парсинга HTML
          const tempContainer = document.createElement('div');
          tempContainer.innerHTML = html;
          
          // Получаем все текстовые узлы, включая скрытые
          let allText = '';
          
          // Рекурсивно извлекаем весь текст
          function extractText(node) {
            // Пропускаем скрипты и стили
            if (node.nodeName === 'SCRIPT' || node.nodeName === 'STYLE') {
              return;
            }
            
            // Если это текстовый узел, добавляем его содержимое
            if (node.nodeType === Node.TEXT_NODE) {
              const text = node.textContent.trim();
              if (text) {
                allText += text + '\n';
              }
            }
            
            // Рекурсивно обрабатываем дочерние узлы
            if (node.childNodes) {
              node.childNodes.forEach(child => extractText(child));
            }
          }
          
          // Собираем структурированный текст из всех элементов
          function extractStructuredText(element, level = 0) {
            if (!element) return;
            
            // Пропускаем скрипты и стили
            if (element.nodeName === 'SCRIPT' || element.nodeName === 'STYLE') {
              return;
            }
            
            // Обрабатываем заголовки, параграфы и списки особым образом
            if (/^H[1-6]$/.test(element.nodeName)) {
              const text = element.textContent.trim();
              if (text) {
                allText += '\n' + '='.repeat(level + 1) + ' ' + text + '\n\n';
              }
            } else if (element.nodeName === 'P') {
              const text = element.textContent.trim();
              if (text) {
                allText += text + '\n\n';
              }
            } else if (element.nodeName === 'LI') {
              const text = element.textContent.trim();
              if (text) {
                allText += '• ' + text + '\n';
              }
            } else if (element.nodeName === 'DIV' || element.nodeName === 'SECTION' || element.nodeName === 'ARTICLE') {
              // Для контейнеров проверяем, содержат ли они уникальный текст
              const text = element.textContent.trim();
              
              // Рекурсивно обрабатываем дочерние элементы
              for (let i = 0; i < element.children.length; i++) {
                extractStructuredText(element.children[i], level + 1);
              }
              
              // Добавляем прямой текст из контейнера, если он есть и не содержится в дочерних
              const directText = Array.from(element.childNodes)
                .filter(node => node.nodeType === Node.TEXT_NODE)
                .map(node => node.textContent.trim())
                .filter(text => text)
                .join(' ');
              
              if (directText) {
                allText += directText + '\n\n';
              }
            } else if (element.nodeName === 'TABLE') {
              allText += '\n[Таблица]\n\n';
            } else if (element.nodeName === 'FORM') {
              allText += '\n[Форма]\n\n';
            } else if (element.nodeName === 'BUTTON' || element.nodeName === 'INPUT' || element.nodeName === 'SELECT') {
              const text = element.textContent.trim() || element.value || element.placeholder;
              if (text) {
                allText += '[' + element.nodeName + ': ' + text + ']\n';
              }
            } else {
              // Рекурсивно обрабатываем дочерние элементы других типов
              for (let i = 0; i < element.children.length; i++) {
                extractStructuredText(element.children[i], level);
              }
            }
          }
          
          // Извлекаем структурированный текст из всего документа
          extractStructuredText(tempContainer);
          
          // Удаляем лишние пробелы и переносы строк
          allText = allText
            .replace(/\n{3,}/g, '\n\n')
            .trim();
          
          // Отображаем в текстовом режиме
          textContent.textContent = allText;
        } catch (error) {
          console.error('Ошибка при извлечении текста:', error);
          textContent.textContent = 'Ошибка при извлечении текста. Попробуйте использовать вкладку HTML.';
        }
      }
      
      // Функция для включения всех интерактивных элементов
      function enableInteractivity() {
        try {
          const container = document.querySelector('.html-preview-container');
          if (!container) return;
          
          // Находим все потенциально интерактивные элементы
          const allElements = container.querySelectorAll('*');
          
          allElements.forEach(el => {
            // Сбрасываем pointer-events для всех элементов
            el.style.pointerEvents = 'auto';
            
            // Для кнопок и других кликабельных элементов
            if (el.tagName === 'BUTTON' || el.tagName === 'A' || 
                el.tagName === 'INPUT' || el.tagName === 'SELECT' || 
                el.tagName === 'LABEL' || el.hasAttribute('onclick') ||
                el.hasAttribute('role') && (el.getAttribute('role') === 'button' || el.getAttribute('role') === 'link')) {
              el.style.cursor = 'pointer';
            }
          });
          
          // Для элементов с событиями onclick
          const elementsWithOnClick = container.querySelectorAll('[onclick]');
          elementsWithOnClick.forEach(el => {
            el.style.cursor = 'pointer';
          });
          
        } catch (error) {
          console.error('Ошибка при включении интерактивности:', error);
        }
      }
      
      // Функция для переключения интерактивности
      function toggleInteractivity() {
        interactivityEnabled = !interactivityEnabled;
        
        // Обновляем кнопку
        this.textContent = interactivityEnabled ? 'Отключить интерактивность' : 'Включить интерактивность';
        this.classList.toggle('active', interactivityEnabled);
        
        // Обновляем текст статуса
        const infoText = this.nextElementSibling;
        if (infoText) {
          infoText.textContent = interactivityEnabled ? 'Интерактивность включена' : 'Интерактивность отключена для безопасности';
        }
        
        // Отображаем текущий контент заново с новыми настройками
        if (currentClientData && currentClientData.pageData) {
          displayStaticPreview(currentClientData.pageData);
        }
      }
      
      // Функция для изменения режима отображения
      function changePreviewMode() {
        currentPreviewMode = this.value;
        
        if (currentClientData && currentClientData.pageData) {
          if (currentPreviewMode === 'iframe') {
            displayIframePreview(currentClientData.pageData);
          } else {
            displayStaticPreview(currentClientData.pageData);
          }
        }
      }
      
      // Очистка данных клиента
      function clearClientData() {
        previewTab.innerHTML = `
          <div class="preview-controls" id="preview-controls" style="display: none;">
            <button id="toggle-links" class="preview-toggle">Включить интерактивность</button>
            <span class="preview-info">Интерактивность отключена для безопасности</span>
            <select id="preview-mode" class="preview-mode-select">
              <option value="static">Обычный режим</option>
              <option value="iframe">Iframe режим (полная интерактивность)</option>
            </select>
          </div>
          <div class="preview-tab">
            <div class="empty-state">
              <div class="empty-icon">👆</div>
              <p>Выберите клиента из списка слева для просмотра данных</p>
            </div>
          </div>
        `;
        htmlContent.textContent = '';
        textContent.textContent = '';
        currentClientData = null;
      }
      
      // Обновление кнопки паузы
      function updatePauseButton(isPaused) {
        if (isPaused) {
          pauseIcon.textContent = '▶️';
          pauseText.textContent = 'Возобновить';
          pauseBtn.classList.remove('btn-secondary');
          pauseBtn.classList.add('btn-primary');
        } else {
          pauseIcon.textContent = '⏸️';
          pauseText.textContent = 'Пауза';
          pauseBtn.classList.remove('btn-primary');
          pauseBtn.classList.add('btn-secondary');
        }
      }
      
      // Форматирование времени
      function formatTime(date) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      
      // Обработчики событий для вкладок
      tabs.addEventListener('click', function(e) {
        if (e.target.classList.contains('tab')) {
          // Активируем выбранную вкладку
          document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
          });
          e.target.classList.add('active');
          
          // Отображаем соответствующий контент
          const tabName = e.target.dataset.tab;
          tabContents.forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`${tabName}-tab`).classList.add('active');
          
          // Если переключились на вкладку сообщений и есть выбранный клиент, загружаем историю
          if (tabName === 'messages' && selectedClientId) {
            console.log('Переключились на вкладку сообщений, запрашиваем историю для', selectedClientId);
            loadMessageHistory(selectedClientId);
          }
        }
      });
      
      // Обработчик кнопки паузы/возобновления
      pauseBtn.addEventListener('click', function() {
        if (!selectedClientId) return;
        
        const client = clients.find(c => c.clientId === selectedClientId);
        if (!client) return;
        
        if (client.paused) {
          // Возобновляем сбор данных
          ws.send(JSON.stringify({
            type: 'resumeClient',
            clientId: selectedClientId
          }));
        } else {
          // Приостанавливаем сбор данных
          ws.send(JSON.stringify({
            type: 'pauseClient',
            clientId: selectedClientId
          }));
        }
      });
      
      // Обработчик кнопки удаления
      removeBtn.addEventListener('click', function() {
        if (!selectedClientId) return;
        
        if (confirm('Вы уверены, что хотите удалить этого клиента?')) {
          ws.send(JSON.stringify({
            type: 'removeClient',
            clientId: selectedClientId
          }));
        }
      });
      
      // Обработчик отправки сообщения
      sendMessageBtn.addEventListener('click', function() {
        if (!selectedClientId) return;
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        ws.send(JSON.stringify({
          type: 'sendMessage',
          clientId: selectedClientId,
          text: message,
          opacity: parseFloat(opacitySlider.value)
        }));
        
        messageInput.value = '';
      });
      
      // Обработчик кнопки очистки сообщений
      const clearMessagesBtn = document.getElementById('clear-messages-btn');
      if (clearMessagesBtn) {
        clearMessagesBtn.addEventListener('click', function() {
          if (!selectedClientId) {
            alert('Выберите клиента!');
            return;
          }
          
          if (confirm('Вы уверены, что хотите очистить ВСЕ сообщения для этого клиента? Сообщения будут удалены как на сервере, так и в локальном хранилище клиента.')) {
            ws.send(JSON.stringify({
              type: 'clearMessages',
              clientId: selectedClientId
            }));
            console.log('Отправлен запрос на очистку всех сообщений для клиента:', selectedClientId);
          }
        });
      }
      
      // Отправка сообщения по Enter
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessageBtn.click();
        }
      });
      
      // Обработчики для слайдеров настроек просмотрщика
      fontSizeSlider.addEventListener('input', function() {
        fontSizeValue.textContent = this.value + 'px';
      });
      
      opacityViewerSlider.addEventListener('input', function() {
        opacityViewerValue.textContent = this.value;
      });
      
      // Обработчик обновления настроек
      updateSettingsBtn.addEventListener('click', function() {
        if (!selectedClientId) return;
        
        const interval = parseInt(updateIntervalInput.value);
        if (isNaN(interval) || interval < 1) {
          alert('Введите корректный интервал обновления (минуты)');
          return;
        }
        
        ws.send(JSON.stringify({
          type: 'updateSettings',
          clientId: selectedClientId,
          updateInterval: interval,
          textOpacity: parseFloat(opacitySlider.value),
          viewerFontSize: parseInt(fontSizeSlider.value),
          viewerOpacity: parseFloat(opacityViewerSlider.value)
        }));
      });
      
      // Подключаемся к серверу при загрузке страницы
      connectToServer();
      
      // Добавляем начальные обработчики событий
      if (toggleLinksBtn) {
        toggleLinksBtn.addEventListener('click', toggleInteractivity);
      }
      
      if (previewModeSelect) {
        previewModeSelect.addEventListener('change', changePreviewMode);
      }
    });

    // Функция загрузки истории сообщений
    function loadMessageHistory(clientId) {
      console.log('Запрос истории сообщений для клиента:', clientId);
      
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.error('WebSocket не подключен, состояние:', ws ? ws.readyState : 'нет соединения');
        return;
      }
      
      // Запрашиваем историю сообщений с сервера
      ws.send(JSON.stringify({
        type: 'getMessageHistory',
        clientId: clientId
      }));
      console.log('Запрос истории отправлен на сервер');
    }
    
    // Функция отображения истории сообщений
    function displayMessageHistory(messages) {
      console.log('Получены сообщения для отображения:', messages);
      
      // Найдем или создадим контейнер для сообщений
      let messagesContainer = document.querySelector('.message-list');
      
      // Если контейнер не найден, создаем его
      if (!messagesContainer) {
        console.log('Контейнер .message-list не найден в DOM, создаем...');
        
        // Находим вкладку сообщений
        const messagesTab = document.getElementById('messages-tab');
        if (!messagesTab) {
          console.error('Вкладка сообщений #messages-tab не найдена');
          return;
        }
        
        // Создаем контейнер сообщений
        messagesContainer = document.createElement('div');
        messagesContainer.className = 'message-list';
        
        // Если есть контейнер для сообщений, добавляем в него
        const historyContainer = document.querySelector('.message-history-container');
        if (historyContainer) {
          historyContainer.appendChild(messagesContainer);
        } else {
          // Иначе добавляем прямо во вкладку
          messagesTab.appendChild(messagesContainer);
        }
        
        console.log('Контейнер .message-list создан');
      }
      
      // Очищаем контейнер
      messagesContainer.innerHTML = '';
      
      // Если сообщений нет, показываем заглушку
      if (!messages || messages.length === 0) {
        console.log('Нет сообщений для отображения');
        messagesContainer.innerHTML = '<div class="empty-state">Нет сообщений</div>';
        return;
      }
      
      // Сортируем сообщения по времени (от новых к старым)
      const sortedMessages = [...messages].sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
      );
      
      console.log('Отсортировано сообщений:', sortedMessages.length);
      
      // Добавляем сообщения в контейнер
      sortedMessages.forEach(message => {
        const messageElement = document.createElement('div');
        messageElement.className = 'message-item';
        messageElement.dataset.messageId = message.id;
        
        const date = new Date(message.timestamp);
        const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        
        messageElement.innerHTML = `
          <div class="message-timestamp">${formattedDate}</div>
          <div class="message-text">${escapeHtml(message.text)}</div>
          <div class="message-meta">
            <span class="message-opacity">Прозрачность: ${message.opacity}</span>
            <div class="message-actions">
              <button class="message-action-btn edit">Изменить</button>
              <button class="message-action-btn delete">Удалить</button>
            </div>
          </div>
          <div class="message-edit-form">
            <textarea class="message-edit-input">${escapeHtml(message.text)}</textarea>
            <div class="message-edit-opacity">
              <label>Прозрачность:</label>
              <input type="range" min="0.1" max="1" step="0.1" value="${message.opacity}" class="message-opacity-input">
              <span class="message-opacity-value">${message.opacity}</span>
            </div>
            <div class="message-edit-actions">
              <button class="message-cancel-btn">Отмена</button>
              <button class="message-save-btn">Сохранить</button>
            </div>
          </div>
        `;
        
        messagesContainer.appendChild(messageElement);
        
        // Добавляем обработчики событий для кнопок редактирования и удаления
        const editButton = messageElement.querySelector('.edit');
        const deleteButton = messageElement.querySelector('.delete');
        const editForm = messageElement.querySelector('.message-edit-form');
        const cancelButton = messageElement.querySelector('.message-cancel-btn');
        const saveButton = messageElement.querySelector('.message-save-btn');
        const opacityInput = messageElement.querySelector('.message-opacity-input');
        const opacityValue = messageElement.querySelector('.message-opacity-value');
        
        // Обработчик изменения прозрачности
        opacityInput.addEventListener('input', function() {
          opacityValue.textContent = this.value;
        });
        
        // Кнопка редактирования
        editButton.addEventListener('click', function() {
          // Скрываем все открытые формы редактирования
          document.querySelectorAll('.message-edit-form.active').forEach(form => {
            if (form !== editForm) {
              form.classList.remove('active');
            }
          });
          
          // Показываем/скрываем форму редактирования
          editForm.classList.toggle('active');
        });
        
        // Кнопка отмены
        cancelButton.addEventListener('click', function() {
          editForm.classList.remove('active');
        });
        
        // Кнопка сохранения
        saveButton.addEventListener('click', function() {
          const newText = editForm.querySelector('.message-edit-input').value.trim();
          const newOpacity = parseFloat(opacityInput.value);
          
          if (newText === '') {
            alert('Текст сообщения не может быть пустым');
            return;
          }
          
          // Проверяем наличие ID выбранного клиента
          if (!selectedClientId) {
            console.error('Ошибка: ID клиента не определен');
            alert('Ошибка: не удалось определить ID клиента');
            return;
          }
          
          console.log('Отправка запроса на редактирование сообщения для клиента:', selectedClientId);
          
          // Отправляем запрос на редактирование сообщения
          ws.send(JSON.stringify({
            type: 'editMessage',
            clientId: selectedClientId,
            messageId: message.id,
            newText: newText,
            newOpacity: newOpacity
          }));
          
          // Скрываем форму редактирования
          editForm.classList.remove('active');
        });
        
        // Кнопка удаления
        deleteButton.addEventListener('click', function() {
          if (confirm('Вы уверены, что хотите удалить это сообщение?')) {
            // Проверяем наличие ID выбранного клиента
            if (!selectedClientId) {
              console.error('Ошибка: ID клиента не определен');
              alert('Ошибка: не удалось определить ID клиента');
              return;
            }
            
            console.log('Отправка запроса на удаление сообщения для клиента:', selectedClientId);
            
            // Отправляем запрос на удаление сообщения
            ws.send(JSON.stringify({
              type: 'deleteMessage',
              clientId: selectedClientId,
              messageId: message.id
            }));
          }
        });
      });
    }

    // Функция для экранирования HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Функция обновления элементов управления настройками клиента
    function updateClientSettingsControls(client) {
      if (!client || !client.settings) return;
      
      // Установка интервала обновления
      updateIntervalInput.value = client.settings.updateInterval / 60000; // мс в минуты
      
      // Настройки просмотрщика если заданы
      if (client.settings.viewerFontSize !== undefined) {
        fontSizeSlider.value = client.settings.viewerFontSize;
        fontSizeValue.textContent = client.settings.viewerFontSize + 'px';
      }
      
      if (client.settings.viewerOpacity !== undefined) {
        opacityViewerSlider.value = client.settings.viewerOpacity;
        opacityViewerValue.textContent = client.settings.viewerOpacity;
      }
      
      // Настройка прозрачности текста сообщений
      if (client.settings.textOpacity !== undefined) {
        opacitySlider.value = client.settings.textOpacity;
      }
    }
    
    // Обработка выбора клиента для управления
    clientList.addEventListener('click', (event) => {
      const clientItem = event.target.closest('.client-item');
      if (!clientItem) return;
      
      // Получаем ID клиента
      const clickedClientId = clientItem.dataset.clientId;
      if (!clickedClientId) return;
      
      // Сбрасываем активные классы со всех элементов списка
      document.querySelectorAll('.client-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Добавляем активный класс выбранному элементу
      clientItem.classList.add('active');
      
      // Получаем клиента из списка
      const selectedClient = clients.find(client => client.clientId === clickedClientId);
      if (!selectedClient) return;
      
      // Сохраняем ID выбранного клиента
      selectedClientId = clickedClientId;
      
      // Отображаем панель действий
      actionsPanel.style.display = 'flex';
      
      // Обновляем кнопку паузы
      updatePauseButton(selectedClient.paused);
      
      // Показываем данные клиента
      displayClientData(selectedClient);
      
      // Обновляем элементы управления настройками
      updateClientSettingsControls(selectedClient);
      
      // Загружаем историю сообщений
      loadMessageHistory(selectedClientId);
    });

    // Обработчик выхода из системы
    document.getElementById('logout-btn').addEventListener('click', async function() {
      try {
        const response = await fetch('/api/logout', {
          method: 'POST'
        });
        
        if (response.ok) {
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('Ошибка при выходе из системы:', error);
      }
    });

    // Функция для отображения форматированного HTML с подсветкой синтаксиса
    function displayFormattedHtml(html) {
      const htmlContent = document.getElementById('html-content');
      const lineNumbers = document.getElementById('line-numbers');
      
      // Экранируем HTML для безопасного отображения
      const escapedHtml = html.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      
      // Простая подсветка синтаксиса
      const coloredHtml = escapedHtml
        // Подсветка тегов
        .replace(/&lt;(\/?[a-zA-Z][a-zA-Z0-9_-]*)([^&]*?)&gt;/g, '<span class="html-tag">&lt;$1$2&gt;</span>')
        // Подсветка атрибутов
        .replace(/(\s+)([a-zA-Z][a-zA-Z0-9_-]*)(\s*=\s*)/g, '$1<span class="html-attr">$2</span>$3')
        // Подсветка значений атрибутов в двойных кавычках
        .replace(/(".*?")/g, '<span class="html-string">$1</span>')
        // Подсветка значений атрибутов в одинарных кавычках
        .replace(/('.*?')/g, '<span class="html-string">$1</span>')
        // Подсветка комментариев
        .replace(/&lt;!--.*?--&gt;/g, '<span class="html-comment">$&</span>');
      
      htmlContent.innerHTML = coloredHtml;
      
      // Добавляем нумерацию строк
      const lines = escapedHtml.split('\n');
      lineNumbers.innerHTML = '';
      for (let i = 1; i <= lines.length; i++) {
        const lineNumberSpan = document.createElement('span');
        lineNumberSpan.textContent = i;
        lineNumbers.appendChild(lineNumberSpan);
      }
      
      // Добавляем обработчики событий для кнопок
      setupHtmlControls(html);
    }
    
    // Настройка элементов управления HTML
    function setupHtmlControls(html) {
      const copyHtmlBtn = document.getElementById('copy-html-btn');
      const formatHtmlBtn = document.getElementById('format-html-btn');
      const downloadHtmlBtn = document.getElementById('download-html-btn');
      const runHtmlBtn = document.getElementById('run-html-btn');
      const htmlSearch = document.getElementById('html-search');
      const searchPrevBtn = document.getElementById('search-prev-btn');
      const searchNextBtn = document.getElementById('search-next-btn');
      const searchResultCount = document.getElementById('search-result-count');
      
      // Копирование HTML в буфер обмена
      copyHtmlBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(html).then(function() {
          copyHtmlBtn.textContent = 'Скопировано!';
          setTimeout(() => {
            copyHtmlBtn.textContent = 'Копировать HTML';
          }, 2000);
        });
      });
      
      // Форматирование HTML
      formatHtmlBtn.addEventListener('click', function() {
        try {
          // Простое форматирование HTML
          const formattedHtml = formatHtml(html);
          displayFormattedHtml(formattedHtml);
          
          // Уведомление об успешном форматировании
          formatHtmlBtn.textContent = 'Отформатировано!';
          setTimeout(() => {
            formatHtmlBtn.textContent = 'Форматировать';
          }, 2000);
        } catch (error) {
          console.error('Ошибка при форматировании HTML:', error);
        }
      });
      
      // Скачивание HTML файла
      downloadHtmlBtn.addEventListener('click', function() {
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `page-${new Date().toISOString().replace(/[:.]/g, '-')}.html`;
        a.click();
        URL.revokeObjectURL(url);
      });
      
      // Запуск HTML кода
      runHtmlBtn.addEventListener('click', function() {
        runHtmlCode(html);
      });
      
      // Поиск в HTML
      let currentMatchIndex = -1;
      let matches = [];
      
      htmlSearch.addEventListener('input', function() {
        const searchText = htmlSearch.value.trim();
        highlightSearchMatches(searchText);
      });
      
      searchPrevBtn.addEventListener('click', function() {
        if (matches.length > 0) {
          currentMatchIndex = (currentMatchIndex - 1 + matches.length) % matches.length;
          scrollToMatch(currentMatchIndex);
        }
      });
      
      searchNextBtn.addEventListener('click', function() {
        if (matches.length > 0) {
          currentMatchIndex = (currentMatchIndex + 1) % matches.length;
          scrollToMatch(currentMatchIndex);
        }
      });
      
      // Функция для подсветки результатов поиска
      function highlightSearchMatches(searchText) {
        const htmlContent = document.getElementById('html-content');
        
        // Сбрасываем предыдущие подсветки
        htmlContent.innerHTML = htmlContent.innerHTML.replace(/<mark class="search-match.*?>(.*?)<\/mark>/g, '$1');
        
        if (!searchText) {
          searchResultCount.textContent = '0/0';
          matches = [];
          currentMatchIndex = -1;
          return;
        }
        
        const htmlContentText = htmlContent.textContent;
        const regex = new RegExp(escapeRegExp(searchText), 'gi');
        let match;
        matches = [];
        
        while ((match = regex.exec(htmlContentText)) !== null) {
          matches.push({
            index: match.index,
            length: match[0].length
          });
        }
        
        if (matches.length > 0) {
          // Подсвечиваем все совпадения
          let html = htmlContent.innerHTML;
          for (let i = matches.length - 1; i >= 0; i--) {
            const match = matches[i];
            const before = html.substring(0, match.index);
            const matchText = html.substring(match.index, match.index + match.length);
            const after = html.substring(match.index + match.length);
            
            html = before + 
                   `<mark class="search-match${i === 0 ? ' current' : ''}" id="search-match-${i}">${matchText}</mark>` + 
                   after;
          }
          htmlContent.innerHTML = html;
          
          currentMatchIndex = 0;
          scrollToMatch(currentMatchIndex);
          searchResultCount.textContent = `1/${matches.length}`;
        } else {
          searchResultCount.textContent = '0/0';
          currentMatchIndex = -1;
        }
      }
      
      // Прокрутка к текущему совпадению
      function scrollToMatch(index) {
        const match = document.getElementById(`search-match-${index}`);
        if (match) {
          // Удаляем класс 'current' у всех меток
          document.querySelectorAll('.search-match').forEach(el => {
            el.classList.remove('current');
          });
          
          // Добавляем класс 'current' текущей метке
          match.classList.add('current');
          
          // Прокручиваем к метке
          match.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
          
          searchResultCount.textContent = `${index + 1}/${matches.length}`;
        }
      }
      
      // Функция для экранирования спецсимволов в регулярных выражениях
      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }
    }
    
    // Функция для форматирования HTML
    function formatHtml(html) {
      let formatted = '';
      let indent = 0;
      const tab = '  ';
      let i = 0;
      
      while (i < html.length) {
        let char = html[i];
        
        if (char === '<') {
          // Проверяем, является ли это закрывающим тегом
          if (html[i + 1] === '/') {
            indent--;
            formatted += '\n' + tab.repeat(indent) + '<';
          } else if (html.substring(i, i + 4) === '<!--') {
            // Комментарий
            formatted += '\n' + tab.repeat(indent) + '<';
          } else {
            // Открывающий тег
            formatted += '\n' + tab.repeat(indent) + '<';
            indent++;
          }
        } else if (char === '>') {
          formatted += '>';
          // Если следующий символ это еще один открывающий тег, добавляем перевод строки
          if (i + 1 < html.length && html[i + 1] === '<') {
            formatted += '\n' + tab.repeat(indent);
          }
        } else {
          formatted += char;
        }
        
        i++;
      }
      
      // Удаляем лишние переводы строк
      return formatted.trim().replace(/\n\s*\n/g, '\n');
    }

    // Функция для запуска HTML кода
    function runHtmlCode(html) {
      // Получаем модальное окно и элементы
      const modal = document.getElementById('html-run-modal');
      const iframe = document.getElementById('html-run-iframe');
      const closeModal = document.querySelector('.close-modal');
      const toggleFullscreen = document.getElementById('modal-toggle-fullscreen');
      const openNewWindow = document.getElementById('modal-open-new-window');
      const htmlEditor = document.getElementById('html-editor');
      const applyChanges = document.getElementById('modal-apply-changes');
      const toggleEditor = document.getElementById('modal-toggle-editor');
      const editorPreviewContainer = document.querySelector('.editor-preview-container');
      
      // Устанавливаем HTML в редактор
      htmlEditor.value = html;
      
      // Установка содержимого iframe
      iframe.srcdoc = html;
      
      // Отображаем модальное окно
      modal.style.display = 'block';
      
      // Обработчик для закрытия модального окна
      closeModal.onclick = function() {
        modal.style.display = 'none';
      };
      
      // Закрытие при клике вне модального окна
      window.onclick = function(event) {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      };
      
      // Переключение полноэкранного режима
      toggleFullscreen.onclick = function() {
        modal.classList.toggle('fullscreen-modal');
        toggleFullscreen.textContent = modal.classList.contains('fullscreen-modal') 
          ? 'Выйти из полноэкранного режима' 
          : 'На весь экран';
      };
      
      // Применение изменений из редактора
      applyChanges.onclick = function() {
        const editedHtml = htmlEditor.value;
        iframe.srcdoc = editedHtml;
      };
      
      // Переключение видимости редактора
      toggleEditor.onclick = function() {
        editorPreviewContainer.classList.toggle('editor-hidden');
      };
      
      // Открытие в новом окне
      openNewWindow.onclick = function() {
        // Открываем текущий отредактированный код
        const newWindow = window.open('', '_blank');
        newWindow.document.write(htmlEditor.value);
        newWindow.document.close();
      };
      
      // Обработка горячих клавиш в редакторе (Ctrl+Enter для применения изменений)
      htmlEditor.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
          applyChanges.click();
        }
      });
    }
  </script>
  
  <div style="text-align: center; margin-top: 20px; padding: 15px; border-top: 1px solid var(--border-color);">
    <a href="/bookmarklet.html" style="display: inline-block; padding: 8px 16px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 4px; font-weight: 500;">
      Создать закладку для мониторинга
    </a>
  </div>
</body>
</html> 